import {
	createContext,
	createSignal,
	onCleanup,
	onMount,
	type ParentProps,
	useContext,
} from "solid-js";
import { uiSettingsStore } from "./store";

export type Locale = "en" | "zh-CN";

const zhCN: Record<string, string> = {
	General: "通用",
	Shortcuts: "快捷键",
	Recordings: "录制",
	Screenshots: "截图",
	Integrations: "集成",
	License: "许可证",
	Experimental: "实验功能",
	Feedback: "反馈",
	Changelog: "更新日志",
	"View previous versions": "查看历史版本",
	"Sign Out": "退出登录",
	"Sign In": "登录",
	"General Settings": "通用设置",
	Appearance: "外观",
	System: "跟随系统",
	Light: "浅色",
	Dark: "深色",
	"Select theme: {theme}": "选择主题：{theme}",
	"Preview of {theme} theme": "{theme}主题预览",
	App: "应用",
	"Always show dock icon": "始终显示程序坞图标",
	"Show Cap in the dock even when there are no windows available to close.": "即使没有可关闭窗口，也在程序坞中显示 Cap。",
	"Enable system notifications": "启用系统通知",
	"Show system notifications for events like copying to clipboard, saving files, and more. You may need to manually allow Cap access via your system's notification settings.": "显示复制到剪贴板、保存文件等事件的系统通知。你可能需要在系统通知设置中手动允许 Cap 的通知权限。",
	Recording: "录制",
	"Instant mode max resolution": "极速模式最大分辨率",
	"Choose the maximum resolution for Instant Mode recordings.": "选择极速模式录制的最大分辨率。",
	"Recording countdown": "录制倒计时",
	"Countdown before recording starts": "录制开始前倒计时",
	Off: "关闭",
	"3 seconds": "3 秒",
	"5 seconds": "5 秒",
	"10 seconds": "10 秒",
	"Main window recording start behaviour": "主窗口录制开始行为",
	"The main window recording start behaviour": "主窗口在开始录制时的行为",
	Close: "关闭",
	Minimise: "最小化",
	"Studio recording finish behaviour": "工作室录制结束行为",
	"The studio recording finish behaviour": "工作室录制结束时的行为",
	"Open editor": "打开编辑器",
	"Show in overlay": "在悬浮层中显示",
	"After deleting recording behaviour": "删除录制后的行为",
	"Should Cap reopen after deleting an in progress recording?": "删除进行中的录制后是否重新打开 Cap？",
	"Do Nothing": "不做任何操作",
	"Reopen Recording Window": "重新打开录制窗口",
	"Delete instant mode recordings after upload": "上传后删除极速模式录制",
	"After finishing an instant recording, should Cap will delete it from your device?": "极速录制完成并上传后是否从本地删除？",
	"Crash-recoverable recording": "可崩溃恢复的录制",
	"Records in fragmented segments that can be recovered if the app crashes or your system loses power. May have slightly higher storage usage during recording.": "录制为分段文件，可在应用崩溃或断电后恢复。录制过程中可能略微增加存储占用。",
	"Max capture framerate": "最大采集帧率",
	"Maximum framerate for screen capture. Higher values may cause instability on some systems.": "屏幕采集的最大帧率。较高的数值可能导致部分系统不稳定。",
	"60 FPS (Recommended)": "60 FPS（推荐）",
	"Higher framerates may cause frame drops or increased CPU usage on some systems.": "更高的帧率可能导致掉帧或更高的 CPU 占用。",
	"Cap Pro Settings": "Cap Pro 设置",
	"Automatically open shareable links": "自动打开分享链接",
	"Whether Cap should automatically open instant recordings in your browser": "Cap 是否应自动在浏览器中打开极速录制",
	"Default Project Name": "默认项目名称",
	"Choose the template to use as the default project and file name.": "选择默认项目和文件名的模板。",
	Reset: "重置",
	Save: "保存",
	"How to customize?": "如何自定义？",
	"Use placeholders in your template that will be automatically filled in.": "使用占位符，系统会自动填充。",
	"Recording Mode": "录制模式",
	'{recording_mode}': "{recording_mode}",
	"Studio": "工作室",
	Instant: "极速",
	Screenshot: "截图",
	"Target": "目标",
	"Display": "屏幕",
	Window: "窗口",
	Area: "区域",
	"Date & Time": "日期与时间",
	"Custom Formats": "自定义格式",
	"Click to copy": "点击复制",
	"The name of the monitor or the title of the app depending on the recording mode.": "根据录制模式显示显示器名称或应用标题。",
	"You can also use a custom format for time. The placeholders are case-sensitive. For 24-hour time, use {moment} or use lower cased hh for 12-hour format.": "你也可以自定义时间格式。占位符区分大小写。24 小时制使用 {moment}；12 小时制使用小写的 hh。",
	"Excluded Windows": "排除的窗口",
	"Choose which windows Cap hides from your recordings.": "选择录制时要隐藏的窗口。",
	"Note:": "提示：",
	"Only Cap related windows can be excluded on Windows due to technical limitations.": "由于技术限制，Windows 上只能排除与 Cap 相关的窗口。",
	"Reset to Default": "恢复默认",
	Add: "添加",
	"No windows are currently excluded.": "当前没有排除任何窗口。",
	"Remove excluded window": "移除排除的窗口",
	Unknown: "未知",
	"Self host": "自托管",
	"Cap Server URL": "Cap 服务器地址",
	"This setting should only be changed if you are self hosting your own instance of Cap Web.": "仅在你自托管 Cap Web 时修改此设置。",
	Update: "更新",
	Language: "语言",
	"Choose the language for the app.": "选择应用语言。",
	English: "英语",
	"Simplified Chinese": "简体中文",
	"Settings": "设置",
	Back: "返回",
	Import: "导入",
	"Show all": "全部",
	"Manage your recordings and perform actions.": "管理你的录制并执行相关操作。",
	"No recordings found": "未找到录制内容",
	"Recording thumbnail": "录制缩略图",
	"Recording in progress": "录制中",
	"Recording failed": "录制失败",
	"Open link": "打开链接",
	Edit: "编辑",
	"The recording failed so this file may have issues in the editor! If your having issues recovering the file please reach out to support!": "录制失败，文件在编辑器中可能存在问题！如果恢复文件时遇到问题，请联系支持。",
	"Recording is potentially corrupted": "录制可能已损坏",
	Reupload: "重新上传",
	"Open recording bundle": "打开录制文件夹",
	Delete: "删除",
	"Are you sure you want to delete this recording?": "确定要删除这条录制吗？",
	"Load more": "加载更多",
	"No": "没有",
	"No matching": "没有匹配的",
	recordings: "录制",
	"instant recordings": "极速录制",
	"studio recordings": "工作室录制",
	"Search recordings": "搜索录制",
	"Manage your screenshots and perform actions.": "管理你的截图并执行相关操作。",
	"No screenshots found": "未找到截图",
	"Search screenshots": "搜索截图",
	screenshots: "截图",
	"Screenshot thumbnail": "截图缩略图",
	"Open folder": "打开文件夹",
	"Open in editor": "在编辑器中打开",
	"Copy image": "复制图片",
	"Are you sure you want to delete this screenshot?": "确定要删除这张截图吗？",
	"Start studio recording": "开始工作室录制",
	"Start instant recording": "开始极速录制",
	"Restart recording": "重新开始录制",
	"Stop recording": "停止录制",
	"Pause/resume recording": "暂停/继续录制",
	"Cycle recording mode": "切换录制模式",
	"Open recording picker": "打开录制选择器",
	"Record display": "录制屏幕",
	"Record window": "录制窗口",
	"Record area": "录制区域",
	"Configure system-wide keyboard shortcuts to control Cap": "配置全局快捷键以控制 Cap",
	"Set hotkeys...": "设置快捷键…",
	None: "无",
	"Experimental Features": "实验功能",
	"These features are still in development and may not work as expected.": "这些功能仍在开发中，可能无法按预期工作。",
	"Recording Features": "录制功能",
	"Custom cursor capture in Studio Mode": "工作室模式自定义光标捕获",
	"Studio Mode recordings will capture cursor state separately for customisation (size, smoothing) in the editor. Currently experimental as cursor events may not be captured accurately.": "工作室模式会单独记录光标状态，以便在编辑器中自定义（大小、平滑度）。目前仍为实验功能，可能无法准确捕获光标事件。",
	"Native camera preview": "原生摄像头预览",
	"Show the camera preview using a native GPU surface instead of rendering it within the webview. This is not functional on certain Windows systems so your mileage may vary.": "使用原生 GPU 表面显示摄像头预览，而不是在 WebView 内渲染。在某些 Windows 系统上可能不可用。",
	"Auto zoom on clicks": "点击自动缩放",
	"Automatically generate zoom segments around mouse clicks during Studio Mode recordings. This helps highlight important interactions in your recordings.": "在工作室模式录制时自动生成点击位置的缩放片段，用于突出重要交互。",
	"Logs uploaded successfully": "日志上传成功",
	"Failed to upload logs": "日志上传失败",
	"Send Feedback": "提交反馈",
	"Help us improve Cap by submitting feedback or reporting bugs. We'll get right on it.": "提交反馈或报告问题，帮助我们改进 Cap。我们会尽快处理。",
	"Tell us what you think about Cap...": "告诉我们你对 Cap 的看法…",
	"Thank you for your feedback!": "感谢你的反馈！",
	"Submitting...": "正在提交…",
	"Submit Feedback": "提交反馈",
	"Join the Community": "加入社区",
	"Have questions, want to share ideas, or just hang out? Join the Cap Discord community.": "有问题、想分享想法，或只是想聊聊？加入 Cap Discord 社区。",
	"Join Discord": "加入 Discord",
	"Debug Information": "调试信息",
	"Upload your logs to help us diagnose issues with Cap. No personal information is included.": "上传日志以帮助我们诊断 Cap 的问题，不包含个人信息。",
	"Uploading...": "正在上传…",
	"Upload Logs": "上传日志",
	"System Information": "系统信息",
	"Loading system information...": "正在加载系统信息…",
	"Operating System": "操作系统",
	"Capture Support": "采集支持",
	"Screen Capture": "屏幕采集",
	Supported: "支持",
	"Not Supported": "不支持",
	"Available Encoders": "可用编码器",
	New: "新",
	"Version {version}": "版本 {version}",
	"S3 Config": "S3 配置",
	"Connect your own S3 bucket for complete control over your data storage. All new shareable link uploads will be automatically uploaded to your configured S3 bucket, ensuring you maintain complete ownership and control over your content. Perfect for organizations requiring data sovereignty and custom storage policies.": "连接你自己的 S3 存储桶，以完全掌控数据存储。所有新的可分享链接上传将自动上传到你配置的 S3 存储桶，确保你对内容拥有完整的所有权和控制权。适合需要数据主权和自定义存储策略的组织。",
	"Configure integrations to extend Cap's functionality and connect with third-party services.": "配置集成以扩展 Cap 功能并连接第三方服务。",
	"Upgrade to Pro": "升级到 Pro",
	Configure: "配置",
	"S3 configuration saved successfully": "S3 配置已保存",
	"S3 configuration deleted successfully": "S3 配置已删除",
	"S3 connection test failed. Check your config and network connection.": "S3 连接测试失败，请检查配置和网络连接。",
	"Connection test timed out after 5 seconds. Please check your endpoint URL and network connection.": "连接测试在 5 秒后超时，请检查 Endpoint 地址和网络连接。",
	"S3 configuration test successful! Connection is working.": "S3 配置测试成功，连接正常。",
	"It should take under 10 minutes to set up and connect your storage bucket to Cap. View the": "设置并连接你的存储桶到 Cap 通常不超过 10 分钟。查看",
	"Storage Config Guide": "存储配置指南",
	"to get started.": "开始使用。",
	"Storage Provider": "存储服务商",
	"Other S3-Compatible": "其他兼容 S3 的服务",
	"Access Key ID": "Access Key ID",
	"Secret Access Key": "Secret Access Key",
	Endpoint: "Endpoint",
	"Bucket Name": "Bucket 名称",
	Region: "区域",
	"Removing...": "正在移除…",
	"Remove Config": "移除配置",
	"Testing...": "正在测试…",
	"Test Connection": "测试连接",
	"Saving...": "正在保存…",
	"Cap Pro License": "Cap Pro 许可证",
	"Your account is upgraded to": "你的账户已升级为",
	"and already includes a commercial license.": "并已包含商业许可证。",
	"Commercial License": "商业许可证",
	"License Key": "许可证密钥",
	Expires: "到期",
	"Deactivate License": "停用许可证",
	"Have a license key?": "已有许可证密钥？",
	"License key": "许可证密钥",
	"Activating...": "正在激活…",
	"Activate License": "激活许可证",
	"For commercial use": "用于商业用途",
	"billed annually": "按年计费",
	"one-time payment": "一次性付款",
	"Switch to": "切换为",
	lifetime: "终身",
	yearly: "年度",
	"Loading...": "加载中…",
	"Purchase License": "购买许可证",
	"Commercial Use of Cap Recorder + Editor": "Cap 录制器和编辑器的商业使用",
	"Community Support": "社区支持",
	"Local-only features": "仅本地功能",
	"Perpetual license option": "永久许可证选项",
	"No Camera": "无摄像头",
	"Show camera preview": "显示摄像头预览",
	"No Microphone": "无麦克风",
	"System audio capture requires macOS 13.0 or later": "系统音频采集需要 macOS 13.0 或更高版本",
	"Record System Audio": "录制系统音频",
	"No System Audio": "不录制系统音频",
	On: "开",
	"Recording Modes": "录制模式",
	"Share instantly with a link. Your recording uploads as you record, so you can share it immediately when you're done.": "录制时即时上传并生成链接，完成后即可立即分享。",
	"Record locally in the highest quality for editing later. Perfect for creating polished content with effects and transitions.": "本地高质量录制，便于后期编辑，适合制作带特效和转场的精致内容。",
	"Capture and annotate screenshots instantly. Great for quick captures, bug reports, and visual communication.": "即时截取并标注截图，适合快速捕捉、问题报告与视觉沟通。",
	"Studio Mode": "工作室模式",
	"Instant Mode": "极速模式",
	"Screenshot copied to clipboard": "截图已复制到剪贴板",
	"Failed to copy screenshot": "截图复制失败",
	"Screenshot saved": "截图已保存",
	"Failed to save screenshot": "截图保存失败",
	"{type} preview for {label}": "{label} 的{type}预览",
	"{label} icon": "{label} 图标",
	"Upload failed": "上传失败",
	"Copy to clipboard": "复制到剪贴板",
	"Save as...": "另存为…",
	"Retry upload": "重试上传",
	"Request Permission": "请求权限",
	"Go Back": "返回",
	"Unable to check for updates.": "无法检查更新。",
	"Please download the latest version manually from cap.so/download. Your data will not be lost.": "请手动从 cap.so/download 下载最新版本。你的数据不会丢失。",
	"If this issue persists, please contact support.": "如果问题仍然存在，请联系支持。",
	"No update available": "没有可用更新",
	"Failed to download or install the update.": "下载或安装更新失败。",
	"Update has been installed. Restart Cap to finish updating.": "更新已安装，请重启 Cap 完成更新。",
	"Restart Now": "立即重启",
	"Installing Update": "正在安装更新",
	"No recordings yet": "还没有录制内容",
	"Your screen recordings will appear here. Start recording to get started!": "你的屏幕录制会显示在这里。开始录制即可。",
	"View All Recordings": "查看所有录制",
	"No screenshots yet": "还没有截图",
	"Your screenshots will appear here. Take a screenshot to get started!": "你的截图会显示在这里。先截图试试吧。",
	"View All Screenshots": "查看所有截图",
	"No displays found": "未找到屏幕",
	"No windows found": "未找到窗口",
	"Search displays": "搜索屏幕",
	"Search windows": "搜索窗口",
	"No matching displays": "没有匹配的屏幕",
	"No matching windows": "没有匹配的窗口",
	"No matching recordings": "没有匹配的录制",
	"No matching screenshots": "没有匹配的截图",
	"Import Error": "导入错误",
	"Failed to import video: {error}": "导入视频失败：{error}",
	"Video Files": "视频文件",
	"Update Error": "更新错误",
	"Unable to check for updates. Please download the latest version manually from cap.so/download. Your data will not be lost.\n\nIf this issue persists, please contact support.": "无法检查更新。请手动从 cap.so/download 下载最新版本。你的数据不会丢失。\n\n如果问题仍然存在，请联系支持。",
	"Version {version} of Cap is available, would you like to install it?": "发现 Cap 新版本 {version}，是否安装？",
	"Update Cap": "更新 Cap",
	Ignore: "忽略",
	"Are you sure you want to change the server URL to '{origin}'? You will need to sign in again.": "确定要把服务器地址改为“{origin}”吗？你需要重新登录。",
	Commercial: "商业",
	Pro: "专业",
	Personal: "个人",
	"Signing In...": "正在登录…",
	"Cancel Sign In": "取消登录",
	"Failed to load recordings": "加载录制失败",
	"Failed to load screenshots": "加载截图失败",
	"Unable to load displays. Try using the Display button.": "无法加载屏幕，请尝试使用“屏幕”按钮。",
	"Unable to load windows. Try using the Window button.": "无法加载窗口，请尝试使用“窗口”按钮。",
	"Choose display": "选择屏幕",
	"Choose window": "选择窗口",
};

const messages: Record<Locale, Record<string, string>> = {
	en: {},
	"zh-CN": zhCN,
};

const isLocale = (value: unknown): value is Locale =>
	value === "en" || value === "zh-CN";

type I18nContextValue = {
	locale: () => Locale;
	setLocale: (next: Locale) => void;
	t: (key: string, vars?: Record<string, string | number>) => string;
};

const I18nContext = createContext<I18nContextValue>();

const applyVars = (
	text: string,
	vars?: Record<string, string | number>,
) => {
	if (!vars) return text;
	return text.replace(/\{(\w+)\}/g, (_, key) =>
		key in vars ? String(vars[key]) : "",
	);
};

export function I18nProvider(props: ParentProps) {
	const [locale, setLocaleSignal] = createSignal<Locale>("en");

	onMount(() => {
		uiSettingsStore.get().then((data) => {
			if (isLocale(data?.language)) setLocaleSignal(data.language);
		});
		const cleanup = uiSettingsStore.listen((data) => {
			if (isLocale(data?.language)) setLocaleSignal(data.language);
		});
		onCleanup(() => cleanup.then((c) => c()));
	});

	const t = (key: string, vars?: Record<string, string | number>) => {
		const current = locale();
		const translated = messages[current]?.[key] ?? key;
		return applyVars(translated, vars);
	};

	const setLocale = (next: Locale) => {
		setLocaleSignal(next);
		void uiSettingsStore.set({ language: next });
	};

	return (
		<I18nContext.Provider value={{ locale, setLocale, t }}>
			{props.children}
		</I18nContext.Provider>
	);
}

export function useI18n() {
	const ctx = useContext(I18nContext);
	if (!ctx) throw new Error("I18nContext not found");
	return ctx;
}

export const localeOptions = [
	{ value: "en", label: "English" },
	{ value: "zh-CN", label: "Simplified Chinese" },
] as const satisfies { value: Locale; label: string }[];
